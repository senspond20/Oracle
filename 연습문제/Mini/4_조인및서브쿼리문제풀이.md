```sql
-- 70년대 생(1970~1979) 중 여자이면서 전씨인 사원의 이름과, 주민번호, 부서명, 직급 조회

SELECT EMP_NAME, EMP_NO, DEPT_TITLE, JOB_NAME
FROM EMPLOYEE
JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
JOIN JOB USING(JOB_CODE)
WHERE SUBSTR(EMP_NO,1,1) = 7 AND -- 70년대생 
      SUBSTR(EMP_NO,8,1) IN(2,4) AND -- 여자
      EMP_NAME LIKE '전%';   --  전씨

-- 856795 주민번호가 6자리 생년월일로 TO_DATE 변환이 불가능한 잘못된 데이터가 들어있다.
-- 주민번호 뒷 두자리리도 35,56,95 식으로 31일 이상의 데이터가 들어가있다.

-- 데이터 수정
COMMIT;
UPDATE EMPLOYEE
SET EMP_NO = '850795-1313513'
WHERE EMP_NO = '856795-1313513';

UPDATE EMPLOYEE
SET EMP_NO = '631126-1548654'
WHERE EMP_NO = '631156-1548654';

UPDATE EMPLOYEE
SET EMP_NO = '621230-1985634'
WHERE EMP_NO = '621235-1985634';

UPDATE EMPLOYEE
SET EMP_NO = '850725-1313513'
WHERE EMP_NO = '850795-1313513';
ROLLBACK;

-- 만나이 계산법 : 태어난 날 기준으로 생일이 지나야 한살먹는다.
SELECT EMP_NO FROM EMPLOYEE;
SELECT TRUNC((SYSDATE - TO_DATE(SUBSTR(EMP_NO,1,6),'RR/MM/DD')) / 360) 만나이 
FROM EMPLOYEE;

--장채현 가장막내 901123 -> 현재 2020-02-15일 네이버 만나이 계산기 : 29세
-- 가장 막내의 사원 코드, 사원 명, 나이, 부서 명, 직급 명 조회
SELECT EMP_ID, EMP_NAME, TRUNC((SYSDATE - TO_DATE(SUBSTR(EMP_NO,1,6),'RR/MM/DD')) / 360) 만나이 , DEPT_TITLE, JOB_NAME
FROM EMPLOYEE
    JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
    JOIN JOB USING(JOB_CODE)
WHERE SUBSTR(EMP_NO,1,6) = 
        (SELECT MAX(TO_NUMBER(SUBSTR(EMP_NO,1,6))) FROM EMPLOYEE);

-- 이름에 ‘형’이 들어가는 사원의 사원 코드, 사원 명, 직급 조회
SELECT EMP_ID, EMP_NAME, JOB_NAME
FROM EMPLOYEE
    JOIN JOB USING (JOB_CODE)
WHERE EMP_NAME LIKE '%형%';

-- 부서 코드가 D5이거나 D6인 사원의 사원 명, 직급, 부서 코드, 부서 명 조회
SELECT EMP_ID, EMP_NAME, DEPT_CODE, DEPT_TITLE
FROM EMPLOYEE
    JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
WHERE DEPT_CODE IN('D5','D6');

-- 보너스를 받는 사원의 사원 명, 보너스, 부서 명, 지역 명 조회
SELECT EMP_NAME, BONUS, DEPT_TITLE, LOCAL_NAME
FROM EMPLOYEE
    JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
    JOIN LOCATION ON (LOCATION_ID = LOCAL_CODE)
WHERE BONUS IS NOT NULL;

-- 사원 명, 직급, 부서 명, 지역 명 조회
SELECT EMP_NAME, JOB_CODE, DEPT_TITLE, LOCAL_NAME
FROM EMPLOYEE
    JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
    JOIN LOCATION ON (LOCATION_ID = LOCAL_CODE);

-- 한국이나 일본에서 근무 중인 사원의 사원 명, 부서 명, 지역 명, 국가 명 조회
SELECT EMP_NAME, DEPT_TITLE, LOCAL_NAME, NATIONAL_NAME
FROM EMPLOYEE
    JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
    JOIN LOCATION ON (LOCAL_CODE = LOCATION_ID)
    JOIN NATIONAL USING(NATIONAL_CODE)
WHERE NATIONAL_CODE = 'KO' OR NATIONAL_CODE = 'JP';

-- 한 사원과 같은 부서에서 일하는 사원의 이름 조회
SELECT * FROM EMPLOYEE;
-- 한 사원을 입력받아서 같은 부서에 일하는 사원 이름들 

SELECT EMP_NAME
FROM EMPLOYEE
WHERE DEPT_CODE = (SELECT DEPT_CODE
                    FROM EMPLOYEE
                    WHERE EMP_NAME = '&사원명');

-- 선동일 입력
--RESULT
--선동일
--송종기
--노옹철

WITH V AS(SELECT '&사원명' V_EMP_NAME FROM DUAL)
SELECT EMP_NAME
FROM EMPLOYEE, V
WHERE DEPT_CODE = (SELECT DEPT_CODE
                    FROM EMPLOYEE
                    WHERE EMP_NAME = V_EMP_NAME)
AND EMP_NAME != V_EMP_NAME;

-- 선동일 입력
--RESULT
--송종기
--노옹철

SELECT N.EMP_NAME
FROM EMPLOYEE E
JOIN EMPLOYEE N ON (E.DEPT_CODE = N.DEPT_CODE) 
WHERE E.EMP_NAME = '&사원명' AND
      E.EMP_NAME != N.EMP_NAME;
      
-- 선동일 입력
--RESULT
--송종기
--노옹철
                    
-- 보너스가 없고 직급 코드가 J4이거나 J7인 사원의 이름, 직급, 급여 조회 (NVL 이용)
SELECT EMP_NAME, JOB_NAME, SALARY
FROM EMPLOYEE
    JOIN JOB USING(JOB_CODE)
WHERE NVL(BONUS, 0) = 0 AND JOB_CODE IN ('J4', 'J7');

-- 직원 테이블에서 보너스 포함한 연봉이 높은 5명의
-- 사번, 이름, 부서명, 직급명, 입사일을 조회하세요

-- 연봉 : (1 + NVL(BONUS,0))* SALARY * 12

-- 1) 올바른 해법
SELECT ROWNUM, EMP_ID, EMP_NAME, DEPT_TITLE, HIRE_DATE
FROM (SELECT * FROM EMPLOYEE
        JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
        ORDER BY (1 + NVL(BONUS,0))* SALARY * 12 DESC)
WHERE ROWNUM <= 5;
        
--2) 잘못된 해법(ROWNUM 의미가 없어짐)
SELECT ROWNUM ,EMP_ID, EMP_NAME, DEPT_TITLE, HIRE_DATE
FROM EMPLOYEE
    JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
WHERE ROWNUM <= 5
ORDER BY (1 + NVL(BONUS,0))* SALARY * 12 DESC; 

--2) 실험
WITH SAL_TOP5 AS( SELECT *
        FROM EMPLOYEE
        WHERE ROWNUM <=5
        ORDER BY (1 + NVL(BONUS,0))* SALARY * 12 DESC)

SELECT ROWNUM,EMP_ID,EMP_NAME,DEPT_TITLE,HIRE_DATE
FROM SAL_TOP5
    JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
ORDER BY (1 + NVL(BONUS,0))* SALARY * 12 DESC;


-- 부서별 급여 합계가 전체 급여 총 합의 20%보다 많은 부서의 부서명과, 부서별 급여 합계 조회
-- 1) having 사용
SELECT DEPT_TITLE, SUM(SALARY) 급여합계
FROM EMPLOYEE
    LEFT JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
GROUP BY DEPT_TITLE
HAVING SUM(SALARY) > (SELECT SUM(SALARY) * 0.2 FROM EMPLOYEE);

-- 2) 인라인 뷰 사용

SELECT DEPT_TITLE, 급여합계
FROM (SELECT DEPT_TITLE, SUM(SALARY) 급여합계
        FROM EMPLOYEE
            LEFT JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
        GROUP BY DEPT_TITLE)
WHERE 급여합계 > (SELECT SUM(SALARY) * 0.2 FROM EMPLOYEE);

-- 3) WITH 사용
WITH SAL AS(SELECT DEPT_TITLE, SUM(SALARY) 급여합계
    FROM EMPLOYEE
    LEFT JOIN DEPARTMENT ON (DEPT_CODE = DEPT_ID)
    GROUP BY DEPT_TITLE)
    
SELECT DEPT_TITLE, 급여합계
FROM SAL
WHERE 급여합계 > (SELECT SUM(SALARY) * 0.2 FROM EMPLOYEE);


```
